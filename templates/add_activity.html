{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}เพิ่มกิจกรรมใหม่{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl mx-auto my-8">
    <h1 class="text-2xl font-bold text-blue-800 mb-6 text-center">เพิ่มกิจกรรมใหม่</h1>

    <!-- <div class="debug-info mb-4 p-2 bg-yellow-100 border border-yellow-400 rounded">
        DEBUG: activity_form exists: {{ activity_form|yesno:"Yes,No" }}<br>
        DEBUG: formset exists: {{ formset|yesno:"Yes,No" }}
    </div> -->
    
    <form method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        
        <!-- ฟอร์ม Activity -->
        <div class="space-y-4">
            {% if activity_form.errors %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <strong class="font-bold">พบข้อผิดพลาด:</strong>
                <span class="block sm:inline">กรุณาตรวจสอบข้อมูลที่กรอก</span>
            </div>
            {% endif %}
            
            {% for field in activity_form %}
                <div class="mb-4">
                    <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-blue-700 mb-1">{{ field.label }}</label>
                    <div>
                        {{ field|add_class:"w-full p-2 border border-blue-300 rounded-md focus:ring-blue-500 focus:border-blue-500" }}
                        {% if field.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                        {% endif %}
                        {% if field.help_text %}
                            <p class="text-gray-500 text-xs mt-1">{{ field.help_text }}</p>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- ฟอร์มอัปโหลดรูปภาพ -->
        <div class="space-y-4" id="image-upload-section">
            <h2 class="text-lg font-semibold text-blue-700">อัปโหลดรูปภาพ</h2>
            {{ formset.management_form }}
            <div id="image-forms">
                {% for form in formset %}
                    <div class="image-form flex items-center space-x-4 mb-2">
                        {{ form.image|add_class:"w-full p-2 border border-blue-300 rounded-md" }}
                        {% if form.image.errors %}
                            <p class="text-red-500 text-sm">{{ form.image.errors.0 }}</p>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add-image" class="text-blue-600 hover:text-blue-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                เพิ่มรูปภาพ
            </button>
        </div>
        
        <!-- ปุ่ม -->
        <div class="flex justify-end space-x-4 mt-6">
            <a href="{% url 'home' %}" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition">กลับไปหน้าแรก</a>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">บันทึก</button>
        </div>
    </form>
</div>

<!-- สคริปต์สำหรับ DateTimeWidget และการเพิ่มรูปภาพ -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // เพิ่มฟิลด์รูปภาพ
        const addButton = document.getElementById('add-image');
        if (addButton) {
            addButton.addEventListener('click', function() {
                const formContainer = document.getElementById('image-forms');
                if (!formContainer) return;
                
                const totalForms = document.getElementById('id_form-TOTAL_FORMS');
                if (!totalForms) return;
                
                const formCount = parseInt(totalForms.value);
                
                // Clone the first form
                if (formContainer.children.length > 0) {
                    const newForm = formContainer.children[0].cloneNode(true);
                    newForm.innerHTML = newForm.innerHTML.replace(/form-\d+/g, `form-${formCount}`);
                    
                    // Clear the input value
                    const input = newForm.querySelector('input');
                    if (input) input.value = '';
                    
                    formContainer.appendChild(newForm);
                    totalForms.value = formCount + 1;
                }
            });
        }
        
        // ตรวจสอบการแสดง/ซ่อนปุ่มเพิ่มรูป
        const firstImageInput = document.querySelector('#image-forms .image-form input');
        if (firstImageInput) {
            addButton.style.display = 'block'; // แสดงปุ่มเสมอ
        }
        
        // Debug
        console.log('Script loaded in add_activity.html');
    });
</script>
{% endblock %}